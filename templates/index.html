<html>
  <head>
    <title>
      bacte data plot
    </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script type="module" defer>
      const input = document.getElementById('FileInput');
      const ctx = document.getElementById('Chart');
      const metadata = document.getElementById('Metadata');
      const datasetSelector = document.getElementById('datasetSelector');
      const chartType = document.getElementById("chartType");
      var currentChart = null;


      function setMetadata(dataset) {
        let meta = dataset["metadata"];
        metadata.replaceChildren();
        let children = ["wavelength", "plate", "sample_group", "absorbance"];
        for (const child of children) {
          let div = document.createElement("div");
          let key = document.createElement("div");
          key.className = "metaKey";
          let value = document.createElement("div");
          div.style["border"] = "1px solid #1e1e1e";
          key.textContent = child.replace("_", " ");
          value.textContent = meta[child] ? meta[child] : "-";
          div.appendChild(key);
          div.appendChild(value);
          metadata.appendChild(div);
        }
      }

      function getDatasets(rows) {
        let sampleKeys = Object.keys(rows[0]).filter(k => k != "Reading" && k != "avg. time [s]");
        let datasets = sampleKeys.map((k, i) => ({
          label: k,
          data: rows,
          parsing: {xAxisKey: "Reading", yAxisKey: k},
          hidden: true
        }));
        return datasets
      }

      function getPeaks(rows) {
        let sampleKeys = Object.keys(rows[0]).filter(k => k != "Reading" && k != "avg. time [s]");
      }

      const upload = (file) => {
        let formData = new FormData();
        formData.append("data-file", input.files[0]);
        fetch("/plot", {
          method: "POST",
          body: formData
        }).then(
            response => {
              datasetSelector.hidden = true;
              chartType.hidden = true;
              if (currentChart != null) {
                currentChart.destroy();
                datasetSelector.replaceChildren();
                metadata.replaceChildren();
              }
              response.json().then((data) => {
                if ("error" in data) {
                  alert(data["error"]);
                  return
                }
                for (let idx = 0; idx < data.length; idx++) {
                  let opt = document.createElement("option");
                  opt.value = idx;
                  opt.textContent = data[idx]["metadata"]["wavelength"];
                  datasetSelector.appendChild(opt);
                }
                let datasets = getDatasets(data[0]["data"]);
                setMetadata(data[0]);
                const chart = new Chart(ctx, {
                  type: "line",
                  data: {
                    datasets:  datasets,
                  },
                  options: {
                    plugins: {
                      legend: {
                        display: true,
                        position: "bottom",
                      }
                    },
                    scales: {
                      x: {
                        type: "linear",
                        title: { display: true, text: "Reading" }
                      },
                      y: { 
                        type: "linear",
                        title: { display: true, text: "Sample" } 
                      }
                    },
                  }
                });
                currentChart = chart; 
                datasetSelector.hidden = false;
                chartType.hidden = false;

                chartType.addEventListener("change", e => {
                  if (currentChart != null) {
                    const hiddenFlags = currentChart.data.datasets.map((_, i) => !currentChart.isDatasetVisible(i));
                    currentChart.config.type = e.target.value;
                    currentChart.data.datasets.forEach((ds, i) => {
                      ds.hidden = hiddenFlags[i];
                    });
                    currentChart.update();
                  }
                });


                datasetSelector.addEventListener("change", e => {
                  let index = e.target.value;
                  let dataset = getDatasets(data[index]["data"]);
                  setMetadata(data[index])
                  if (currentChart != null) {
                    currentChart.data.datasets = datasets;
                    currentChart.update();
                  }
                });
              })
            }
        );
      };

      const onFileSelected = () => upload(input.files[0]);
      input.addEventListener('change', onFileSelected, false);

    </script>
    <style>

    html, body {
      height: 100%;
      padding: 0;
      margin: 0;
    }

    .flex {
      display: flex;
    }

    .row {
      flex-direction: row;
    }

    .col {
      flex-direction: column;
    }

    #ChartControls {
      padding: 0;
      margin: 0;
      gap: 10px;
    }

    #Header {
      background: linear-gradient(45deg, #a6e3a1, #94e2d5, #89dceb);
      border-bottom: 1px solid #1e1e1e;
      justify-content: center;
      padding: 10px;
    }
    
    #Metadata {
      padding: 10px;
      gap: 20px;
    }

    #Metadata > div {
      border-radius: 5px;
      background-attachment: fixed;
      background: linear-gradient(45deg, #f9e2af);
      display: flex;
      flex-direction: row;
    }

    #Metadata > div > div {
      padding: 5px 10px;
    }

    .metaKey {
      border-right: 1px solid #1e1e1e;
    }

    </style>
  </head>
  <body>
    <div id="Header" class="flex col">
      <div id="ChartControls">    
        <input type="file" id="FileInput" accept=".xlsx"/>
        <select id="datasetSelector" hidden></select>
        <select id="chartType" hidden>
          <option value="line" selected>Line</option>
          <option value="bar">Bar</option>
          <option value="scatter">Scatter</option>
        </select>
      </div>
    </div>
    <div id="Metadata" class="flex row">
    </div>
    <canvas id="Chart"></canvas>
  </body>
</html>
